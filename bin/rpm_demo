#!/usr/bin/python
# -*- coding: utf-8 -*-
# version: 20120916
# By Dennis Drescher (dennis_drescher at sil.org


###############################################################################
######################### Description/Documentation ###########################
###############################################################################

# One script to rule them all.  This is the mother script of the whole system.
# This script will drive all processes and keep track of what happens in the
# project log in each respective project.

# History:
# 20111202 - djd - Start with copy of rpm and stripped out all the rpm related
# stuff to have just the demo stuff


###############################################################################
################################ Initialize RPM ###############################
###############################################################################
# Firstly, import all the standard Python modules we need for this process and
# set the base path

import os, sys

# Set the RPM base program path
rpmHome = os.environ.get('RPM_BASE')
if not rpmHome :
    rpmHome = os.path.join('usr', 'share', 'rpm')
    os.environ['RPM_BASE'] = rpmHome

# Set the user environment path
userHome = os.environ.get('RPM_USER')
if not userHome :
    sysHome = os.environ.get('HOME')
    userHome = os.path.join(sysHome, '.config', 'rpm')
    os.environ['RPM_USER'] = userHome

# Set the (potential) project home
projHome = os.getcwd()

# Set our paths to application resources
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'core'))
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'manager'))
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'project'))
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'component'))

# Load standard Python modules
import codecs, shutil, operator, argparse, subprocess, zipfile
from datetime import *
from configobj import ConfigObj


# Load the local classes
from proj_local import ProjLocal
from proj_log import ProjLog
from tools import *
from user_config import UserConfig
from proj_config import ProjConfig
from project import Project

# Instantiate User classes
local           = ProjLocal(rpmHome, userHome, projHome)
uc              = UserConfig(local)
log             = ProjLog(local, uc)

# Pull some info from the user config
systemName      = uc.userConfig['System']['systemName']
systemVersion   = uc.userConfig['System']['systemVersion']

# Give a welcome message
terminal('\n\t\tWelcome to ' + systemName + '  ' + systemVersion + '\n')


###########################################################################
########################### RPM Demo Functions ############################
###########################################################################



###############################################################################
############################### Testing Functions #############################
###############################################################################

# These need to be moved out to a seperate script

def getExampleSourceProject (exampID) :
    '''Create a test project from example projects located in the 
    example_lib folder in the RPM system. This is for system testing
    and nifty canned demos.'''

    exampleFile = os.path.join(local.rpmExamplesFolder, exampID + '.zip')
    demoFile = os.path.join(local.projHome, exampID, exampID + '.rpmDemo')
    thisZipFile = zipfile.ZipFile(exampleFile, 'r')
    if os.path.isfile(exampleFile) :
        thisZipFile.extractall()
        terminal('Extracted the [' + exampID + '] ParaTExt example project.')

def runExamplePubDemoProject (demoID) :
    '''Run an example demo file to test/demonstrate a project.'''

    # FIXME: Everywhere else we use subprocess.call() to do a process.  However,
    # in this case it takes too much fiddling to get a these more complex RPM
    # calls to run from within RPM.  To make it easy, we use os.system() to make
    # the call out.
    demoFile = os.path.join(local.projHome, demoID + '.rpmDemo')
    if os.path.isfile(demoFile) :
        demo = codecs.open(demoFile, "r", encoding='utf_8')
        for line in demo :
            if line[:1] != '#' and line[:1] != '' and line[:1] != '\n' :
                os.system(line)
        return True
    else :
        terminal('File not found: ' + fName(demoFile))


###############################################################################
############################# RPM Command Center ##############################
###############################################################################

# All command options must contain a project ID (-i). That is required. If one
# is not listed then the incoming command is either considered malformed or
# incomplete. If there is a way to figure out what the user might be needing
# the help system will be called. Otherwise, RPM will quite.

# The argument handler
def userArguments (args) :
    '''Process incoming command arguments.'''

    # Testing commands
    if sys.argv[1].lower() == 'test' :
        if args['source_id'] :
            getExampleSourceProject(args['source_id'])

        if args['demo_id'] :
            runExamplePubDemoProject(args['demo_id'])

    # Extra help access
    elif sys.argv[2].lower() == 'help' :
        if args['about'] :
            terminal('\n' + systemName + ' version ' + systemVersion + '\n')
            terminal('About: ' + systemAbout + '\n')

        if args['basic'] :
            accessHtmlHelp()

    # Totally lost
    else:
        sys.exit('Error: Command not recognized! ')


###############################################################################
############################### Argparser Setup ###############################
###############################################################################

# Setup the arg parser
parser = argparse.ArgumentParser(description=systemName)
subparsers = parser.add_subparsers(help='sub-command help')

# Add help subprocess arguments
helpCommand = subparsers.add_parser('help', help='General system help')

# Add main arguments (first postion options)
parser.add_argument('-a', '--about', action='store_true', help = 'About RPM')
parser.add_argument('-b', '--basic', action='store_true', help = 'Basic RPM help (in HTML)')

# Add testing subprocess arguments
testCommand = subparsers.add_parser('test', help='General system testing commands help')
testCommand.add_argument('-s', '--source_id', help='Example source ID of the test project taken from the example library you want to setup. This should be a valid ZIP file name, without the .zip extention.')
testCommand.add_argument('-d', '--demo_id', help='Example demo ID of the publishing test project taken from the source example that was (or is to be) setup. The ID is combined with a \'.rpmDemo\' extention which should be a valid file name.')

# Send the collected arguments to the handler
userArguments(vars(parser.parse_args()))


###############################################################################
########################### Close out the session #############################
###############################################################################


# In case there are any Canadians using this, politely say good bye
terminal('\n\t\tThank you, please come again!\n')


