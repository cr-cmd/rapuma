#!/usr/bin/python
# -*- coding: utf-8 -*-
# version: 20110823
# By Dennis Drescher (dennis_drescher at sil.org


###############################################################################
######################### Description/Documentation ###########################
###############################################################################

# One script to rule them all.  This is the mother script of the whole system.
# This script will drive all processes and keep track of what happens in the
# project log in each respective project.

# History:
# 20111202 - djd - Start over with manager-centric model


###############################################################################
################################ Initialize RPM ###############################
###############################################################################
# Firstly, import all the standard Python modules we need for this process and
# set the base path

import os, sys

# Set basic system vars
systemName = "Rapid Publication Manager (RPM)"
systemVersion = "0.0.1"
systemAbout = "RPM is a Scripture publishing management system written by the friendly developers at Payap University\'s Linguistics Institute (Text Unit). RPM stands for Rapid Publication Manager. It is currently being deployed in MSEAG and is under heavy development. Anyone wanting to try this system should be warned that it may not work in their context. However, the underlying principals of the system should work in any long document publishing environment. Therefore the package should be evaluated with that in mind. We welcome input and participation in this project. It is our hope it will be able to serve more than just MSEAG. For questions or more information please write: dennis_drescher@sil.org."


# Set the RPM base program path
rpmHome = os.environ.get('RPM_BASE')
if not rpmHome :
    rpmHome = os.path.join('usr', 'share', 'rpm')
    os.environ['RPM_BASE'] = rpmHome

# Set the user environment path
userHome = os.environ.get('RPM_USER')
if not userHome :
    sysHome = os.environ.get('HOME')
    userHome = os.path.join(sysHome, '.config', 'rpm')
    os.environ['RPM_USER'] = userHome

# Set the location for RPM internal configuration
rpmConfig = os.path.join(rpmHome, 'bin', 'config')

# Set the (potential) project home
projHome = os.getcwd()

# Set our paths to application resources
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'core'))
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'manager'))
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'project'))
sys.path.insert(0, os.path.join(rpmHome, 'python_lib', 'rpm', 'component'))

# Load standard Python modules
import codecs, shutil, operator
from datetime import *
from configobj import ConfigObj

# Load the local classes
from tools import *
from user_config import UserConfig
from sys_command import Command, commands
from project import *

# Catch any incoming commands here
command = ""
opts = []

if len(sys.argv) > 1 :
    command = sys.argv[1]
    opts = sys.argv[2:]


###############################################################################
######################## Load User and Project Info ###########################
###############################################################################

# Instantiate User and Project classes
uConf = UserConfig(userHome, rpmHome)
aProject = Project(uConf._userConfig, projHome, userHome, rpmHome)


# Look for the project.conf and init the project if it is there.
# Otherwise we will just pass through and quite
if os.path.isfile(aProject.projConfFile) :
    aProject.initProject()


###############################################################################
############################### Terminal Startup ##############################
###############################################################################

# Give a welcome message
terminal('\n\t\tWelcome to ' + systemName + '  ' + systemVersion)
terminal('\t\tCurrent User: ' + aProject._userConfig['System']['userName'])
if os.path.isfile(aProject.projConfFile) :
    terminal('\t\tProject: ' + aProject._projConfig['ProjectInfo']['projectName'] + ' (' + aProject._projConfig['ProjectInfo']['projectIDCode'] + ')')
    terminal('\t\tProject Type: ' + aProject._projConfig['ProjectInfo']['projectType'])
    if command :
        terminal('\t\tCurrent Command: ' + command + ' ' + str(opts))
    else :
        terminal('\n\t\tType \"rpm help\" for a list of current commands')
            
else :
    # Just put out an almost blank line
    terminal(' ')

###############################################################################
##################### Prepare and Process RPM Commands #######################
###############################################################################

# Run the command and pass along the aProject object
if command :
    if len(opts) >= 1 :
        try :
            aProject.run(command, opts, uConf._userConfig)
        except SyntaxError, err:
            terminal("\n" + str(err) + "\n")
            opts.insert(0, command)
            aProject.help(command, opts, uConf._userConfig)
    else :
        # If we seem to be short on options then we will just display the help
        # for this command
            terminal('\nHelp for the \"' + command + '\" command:\n')
            aProject.help(command, opts, uConf._userConfig)


###############################################################################
########################### Closeout RPM Session #############################
###############################################################################

# Now write out the config files if needed
if aProject.writeOutProjConfFile :
    if not writeConfFile(aProject._projConfig, aProject.projConfFile) :
        terminal('\nERROR: Could not write to: project config file')
if uConf.writeOutUserConfFile :
    if not writeConfFile(uConf._userConfig, uConf.userConfFile) :
        terminal('\nERROR: Could not write to: user config file')

# Now trim the log file if it is needed
if isConfSection(aProject._projConfig, 'Project') :
    aProject.trimLog(aProject._userConfig['System']['projLogLineLimit'])

## In case there are any Canadians using this, politely say good bye

terminal('Dev: Continue work in usfm.py around line 137')

terminal('\n\t\tThank you, please come again!\n')


